<!doctype html>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Map</title>
</head>
<body>
<div class="container">
    <div>
        <h1>지도 기능</h1>
    </div>
    <div th:text="${nickname}"></div>
    <div>
        <label for="time"> 시간 :</label>
        <input type="number" id="time" placeholder="초">
    </div>
    <div>
        <label for="distance">거리(km) :</label>
        <input type="number" id="distance" placeholder="km">
    </div>
    <div>
        <p> 칼로리 :  <span id="calories">0</span>kcal</p>
    </div>
    <button id="startBtn"> 시작 </button>
    <button id="stopBtn"> STOP</button>
</div>
<script>
/*
ToDo : 오늘 날짜 + 시간 + 거리 + 칼로리 밑에 찍어야 함
*/
    const startButton = document.getElementById("startBtn");
    const stopButton = document.getElementById("stopBtn");
    const timeInput = document.getElementById("time");
    const distanceInput = document.getElementById("distance");
    const caloriesDisplay = document.getElementById("calories");
    const dateDisplay = document.getElementById("date");
    let currentTime = 0;
    let currentDate = 0;
    let currentTimeObject = 0;
    let currentTimeString = 0;
    let intervalId;
    let startTime;
    let currentCalories = 0;
    let currentDistance = 0;

    startButton.addEventListener("click", () => {
        startMeasurement();
    });

    stopButton.addEventListener("click", () => {
        stopMeasurement();
    });

    function startMeasurement() {
        startTime = new Date();
        currentCalories = 0; // 측정 시작할 때 칼로리 초기화
        currentDistance = 0; // 측정 시작할 때 거리 초기화
        intervalId = setInterval(() => {
            updateMeasurement();
        }, 1000); // 1초마다 업데이트
    }

    function stopMeasurement() {
        clearInterval(intervalId); // 타이머 중지
        currentTime = parseInt(timeInput.value);
        currentDate = new Date().toLocaleDateString();
        currentTimeObject = new Date(startTime);
        currentTimeString = currentTimeObject.getHours().toString().padStart(2, '0') + ':' +
                                 currentTimeObject.getMinutes().toString().padStart(2, '0');

        const measurementData = {
            mtime: currentTime,
            mdistance: currentDistance.toFixed(2),
            mdatetime: `${currentDate} ${currentTimeString}`,
            mykcals: currentDistance * 100 // 소수점 2자리까지
        };

        // 실제 GPS 데이터를 얻어와서 이동거리와 칼로리를 계산
        // 아래 코드는 임의의 랜덤 값을 사용한 예시입니다.
        const gpsDistance = currentDistance; // 현재까지 누적 이동거리를 사용
        const gpsCalories = gpsDistance * 100; // 간단한 칼로리 계산식

        console.log('GPS 이동거리:', gpsDistance.toFixed(2));
        console.log('GPS 칼로리 소모:', gpsCalories.toFixed(2));
        console.log('GPS 시간:', currentTime);
        console.log('현재 시간:',`${currentDate} ${currentTimeString}`);

        // 서버에 전송하는 fetch 코드
        fetch('/map/jsonInfo',{
            method:'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body:JSON.stringify(measurementData)
        })
        .then(response => response.json())
        .then(data=>{
            console.log('Received response from server:', data);
        })
        .catch(error=>{
            console.error('Error sending JSON data:', error);
        });
    }

    function updateMeasurement() {
        const currentTime = new Date();
        const elapsedTimeInSeconds = Math.floor((currentTime - startTime) / 1000);
        timeInput.value = elapsedTimeInSeconds; // 초를 시간 입력 필드에 표시
        updateCaloriesAndDistance(elapsedTimeInSeconds);
    }

    function updateCaloriesAndDistance(seconds) {
        // 예시로 간단한 칼로리 계산식 사용
        currentCalories = Math.floor(seconds * 0.1); // 초에 따라 칼로리 갱신
        caloriesDisplay.textContent = currentCalories;

        // 예시로 간단한 거리 계산식 사용
        const gpsDistancePerSecond = 0.005; // 초당 이동거리 (임의의 값)
        currentDistance = seconds * gpsDistancePerSecond; // 초에 따라 거리 갱신
        distanceInput.value = currentDistance.toFixed(2);
    }

    </script>
</body>
</html>
